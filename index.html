 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eco-Friendly Homework Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --eco-green: #2e7d32;
            --eco-light-green: #4caf50;
            --eco-bg: #f1f8e9;
            --eco-card: #ffffff;
            --eco-text: #1b5e20;
            --eco-secondary: #7cb342;
            --eco-accent: #558b2f;
            --eco-warning: #ff9800;
            --eco-error: #f44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--eco-bg);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        /* Prevent horizontal scroll */
        html, body {
            max-width: 100%;
            overflow-x: hidden;
        }

        /* Eco-friendly header */
        header {
            background: linear-gradient(135deg, var(--eco-green) 0%, var(--eco-light-green) 100%);
            color: white;
            padding: 20px 15px;
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.2);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            font-size: 1.6rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .eco-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }

        /* Container for mobile */
        .mobile-container {
            flex: 1;
            width: 100%;
            max-width: 100%;
            overflow-x: hidden;
            padding: 15px;
            margin-bottom: 80px; /* Space for fixed bottom nav */
        }

        /* Cards with eco theme */
        .card {
            background: var(--eco-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-left: 5px solid var(--eco-secondary);
        }

        .subject-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .subject-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--eco-text);
        }

        .status-chip {
            background: var(--eco-accent);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Details grid for mobile */
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-size: 0.8rem;
            color: #5f6368;
            font-weight: 500;
        }

        .detail-value {
            font-size: 1rem;
            color: var(--eco-text);
            font-weight: 600;
        }

        /* Upload countdown */
        .upload-countdown {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px dashed #e0e0e0;
        }

        .countdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .countdown-label {
            font-size: 0.9rem;
            color: #5f6368;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .countdown-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--eco-green);
            background: #e8f5e9;
            padding: 5px 12px;
            border-radius: 8px;
            min-width: 110px;
            text-align: center;
        }

        /* Scrollable galleries */
        .gallery-container {
            margin-top: 20px;
            overflow: hidden;
        }

        .gallery-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--eco-text);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Horizontal scrollable container */
        .scrollable-gallery {
            display: flex;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            gap: 15px;
            padding-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--eco-secondary) #e0e0e0;
            -webkit-overflow-scrolling: touch;
        }

        .scrollable-gallery::-webkit-scrollbar {
            height: 8px;
        }

        .scrollable-gallery::-webkit-scrollbar-track {
            background: #e0e0e0;
            border-radius: 10px;
        }

        .scrollable-gallery::-webkit-scrollbar-thumb {
            background: var(--eco-secondary);
            border-radius: 10px;
        }

        /* Gallery items */
        .gallery-item {
            flex: 0 0 auto;
            width: 280px;
            scroll-snap-align: start;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .gallery-item:hover {
            transform: translateY(-5px);
        }

        .gallery-preview {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 2px solid #eaeaea;
        }

        .pdf-preview {
            background: linear-gradient(135deg, #fff5f5 0%, #ffeaea 100%);
        }

        .gallery-preview i {
            font-size: 64px;
        }

        .pdf-preview i {
            color: #ea4335;
        }

        .image-preview i {
            color: var(--eco-green);
        }

        .gallery-info {
            padding: 15px;
        }

        .gallery-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--eco-text);
            margin-bottom: 12px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .gallery-actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-view {
            background: #e8f5e9;
            color: var(--eco-green);
        }

        .btn-download {
            background: var(--eco-green);
            color: white;
        }

        .btn:hover, .btn:active {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* PDF Viewer Modal for mobile */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 10px;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            width: 100%;
            height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 15px;
            background: var(--eco-green);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1rem;
            font-weight: 600;
            max-width: 80%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .pdf-viewer {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .pdf-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 20px;
            right: 20px;
            background: var(--eco-accent);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: none;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #5f6368;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #eaeaea;
            border-top-color: var(--eco-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #5f6368;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        /* Fixed Bottom Navigation - ALWAYS VISIBLE */
        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background: white;
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            z-index: 99;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            background: rgba(255, 255, 255, 0.95);
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #5f6368;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 8px;
            flex: 1;
            max-width: 80px;
        }

        .nav-item.active {
            color: var(--eco-green);
            background: #e8f5e9;
            transform: translateY(-5px);
        }

        .nav-item i {
            font-size: 1.2rem;
        }

        /* Enhanced Image viewer modal with zoom, drag and rotate */
        .image-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.98);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 10px;
            touch-action: none;
            overflow: hidden;
        }

        .image-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: grab;
        }

        .image-container.grabbing {
            cursor: grabbing;
        }

        .image-modal-img {
            max-width: 100%;
            max-height: 85vh;
            object-fit: contain;
            transition: transform 0.1s ease-out;
            transform-origin: center center;
            user-select: none;
            -webkit-user-drag: none;
            touch-action: none;
        }

        /* Image controls */
        .image-controls {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .image-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .image-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .image-modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        /* Image navigation arrows */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 10;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .nav-arrow:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-50%) scale(1.1);
        }

        .nav-arrow-left {
            left: 20px;
        }

        .nav-arrow-right {
            right: 20px;
        }

        .nav-arrow.show {
            display: flex;
        }

        /* Image counter */
        .image-counter {
            position: absolute;
            bottom: 80px;
            left: 0;
            right: 0;
            text-align: center;
            color: white;
            font-size: 1rem;
            z-index: 10;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin: 0 auto;
            width: fit-content;
            backdrop-filter: blur(5px);
        }

        /* Download button in image viewer */
        .image-download-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--eco-green);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            z-index: 10;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .image-download-btn:hover {
            background: var(--eco-light-green);
            transform: scale(1.1);
        }

        /* Zoom controls */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            display: flex;
            gap: 10px;
            z-index: 10;
        }

        .zoom-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .zoom-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Reset zoom/rotate button */
        .reset-btn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            z-index: 10;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }

        .reset-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Zoom level indicator */
        .zoom-level {
            position: absolute;
            top: 80px;
            right: 20px;
            color: white;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        /* Rotate indicator */
        .rotate-indicator {
            position: absolute;
            top: 120px;
            right: 20px;
            color: white;
            font-size: 0.9rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            z-index: 10;
            backdrop-filter: blur(5px);
        }

        /* Eco-friendly tips */
        .eco-tip {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .eco-tip i {
            color: var(--eco-green);
            font-size: 1.2rem;
        }

        .eco-tip p {
            font-size: 0.9rem;
            color: var(--eco-text);
        }

        /* Full Screen Galleries */
        .fullscreen-gallery {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 30px;
            background: var(--eco-bg);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 80px; /* Space for bottom nav */
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--eco-secondary);
        }

        .gallery-header h2 {
            color: var(--eco-text);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-gallery {
            background: var(--eco-green);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* Grid layout for fullscreen gallery - 2 images per row */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding-bottom: 20px;
        }

        .grid-item {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
        }

        .grid-item:hover {
            transform: translateY(-5px);
        }

        .grid-preview {
            width: 100%;
            height: 150px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 2px solid #eaeaea;
        }

        .grid-info {
            padding: 12px;
        }

        .grid-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--eco-text);
            margin-bottom: 10px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .grid-actions {
            display: flex;
            gap: 8px;
        }

        /* Download page */
        .download-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 30px;
            background: var(--eco-bg);
            z-index: 9999;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 80px; /* Space for bottom nav */
        }

        .download-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 15px;
            border-bottom: 2px solid var(--eco-secondary);
        }

        .download-header h2 {
            color: var(--eco-text);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .download-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .download-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .file-icon.image {
            background: #e8f5e9;
            color: var(--eco-green);
        }

        .file-icon.pdf {
            background: #ffebee;
            color: #ea4335;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--eco-text);
            margin-bottom: 3px;
        }

        .file-size {
            font-size: 0.8rem;
            color: #5f6368;
        }

        /* Empty animation for download page */
        .empty-download-animation {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .empty-animation-container {
            position: relative;
            width: 150px;
            height: 150px;
            margin-bottom: 25px;
        }

        .empty-circle {
            position: absolute;
            width: 100%;
            height: 100%;
            border: 3px dashed var(--eco-secondary);
            border-radius: 50%;
            animation: rotate 20s linear infinite;
        }

        .empty-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: var(--eco-secondary);
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        /* Countdown timer at bottom */
        .countdown-timer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #333 0%, #555 100%);
            color: white;
            padding: 8px 15px;
            font-size: 0.85rem;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            z-index: 101;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        .countdown-timer i {
            color: #ff9800;
        }

        .countdown-text {
            font-weight: 600;
        }

        .countdown-value {
            font-weight: 700;
            color: #ff9800;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            min-width: 120px;
            text-align: center;
        }

        /* Deletion countdown (below date) */
        .deletion-countdown {
            margin-top: 10px;
            padding: 10px;
            background: #fff8e1;
            border-radius: 8px;
            border-left: 4px solid #ff9800;
        }

        .deletion-countdown .label {
            font-size: 0.8rem;
            color: #5d4037;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
        }

        .deletion-countdown .value {
            font-size: 1rem;
            font-weight: 700;
            color: #e65100;
            text-align: center;
        }

        /* Download progress indicator */
        .download-progress {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            z-index: 10001;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            min-width: 250px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--eco-green);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* Swipe to go back indicator */
        .swipe-back-indicator {
            position: fixed;
            top: 50%;
            left: 10px;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.5rem;
            z-index: 5;
            background: rgba(0, 0, 0, 0.5);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .swipe-back-indicator.show {
            opacity: 1;
        }

        /* Pinch zoom indicator */
        .pinch-indicator {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 0.8rem;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 15px;
            z-index: 5;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .pinch-indicator.show {
            opacity: 1;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
            
            .gallery-item {
                width: 250px;
            }
            
            .gallery-grid {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.4rem;
            }
            
            .btn {
                padding: 10px 12px;
                font-size: 0.85rem;
            }
            
            .countdown-timer {
                font-size: 0.75rem;
                padding: 6px 10px;
            }
            
            .nav-arrow {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            .nav-arrow-left {
                left: 10px;
            }
            
            .nav-arrow-right {
                right: 10px;
            }
            
            .bottom-nav {
                padding: 12px 10px;
            }
            
            .nav-item {
                font-size: 0.75rem;
                padding: 5px 8px;
            }
            
            .nav-item i {
                font-size: 1rem;
            }
        }
        
        @media (max-width: 360px) {
            .gallery-item {
                width: 220px;
            }
            
            .gallery-actions {
                flex-direction: column;
            }
            
            .grid-actions {
                flex-direction: column;
            }
            
            .bottom-nav {
                padding: 10px 5px;
            }
        }
        
        @media (min-width: 768px) {
            .gallery-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        /* Orientation change handling */
        @media (orientation: landscape) {
            .image-modal-img {
                max-height: 75vh;
            }
            
            .bottom-nav {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Eco-friendly header -->
    <header>
        <div class="header-content">
            <div>
                <h1>
                    <i class="fas fa-leaf"></i>
                    <span id="pageTitle">Eco Homework Viewer</span>
                </h1>
                <div class="eco-badge">
                    <i class="fas fa-recycle"></i>
                    <span>Paperless & Eco-Friendly</span>
                </div>
            </div>
            <button class="btn btn-view" id="refreshBtn" style="background: rgba(255, 255, 255, 0.2); color: white;">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
    </header>

    <!-- Main content container -->
    <div class="mobile-container">
        <!-- Eco tip -->
        <div class="eco-tip">
            <i class="fas fa-lightbulb"></i>
            <p>Viewing homework digitally saves paper and helps protect our planet!</p>
        </div>

        <!-- Homework Details -->
        <div class="card">
            <div class="subject-row">
                <div class="subject-title" id="subjectTitle">Loading...</div>
                <div class="status-chip" id="statusChip">ACTIVE</div>
            </div>
            
            <div class="details-grid">
                <div class="detail-item">
                    <span class="detail-label">Subject</span>
                    <span class="detail-value" id="subjectValue">--</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Date</span>
                    <span class="detail-value" id="dateValue">--</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">Images</span>
                    <span class="detail-value" id="imagesCount">0</span>
                </div>
                <div class="detail-item">
                    <span class="detail-label">PDFs</span>
                    <span class="detail-value" id="pdfsCount">0</span>
                </div>
            </div>
            
            <!-- Upload Countdown (30 days from upload) -->
            <div class="upload-countdown">
                <div class="countdown-item">
                    <div class="countdown-label">
                        <i class="fas fa-upload"></i>
                        <span>Uploaded:</span>
                    </div>
                    <div class="countdown-value" id="uploadTimeValue">--:--:--:--</div>
                </div>
                <div class="deletion-countdown" id="deletionCountdown" style="display: none;">
                    <div class="label">
                        <i class="fas fa-clock"></i>
                        <span>Time remaining:</span>
                    </div>
                    <div class="value" id="deletionCountdownValue">30:00:00:00</div>
                </div>
            </div>
        </div>

        <!-- Images Gallery -->
        <div class="card" id="imagesSection" style="display: none;">
            <div class="gallery-title">
                <i class="fas fa-images"></i>
                <span>Images Gallery</span>
            </div>
            <div class="scrollable-gallery" id="imagesGallery">
                <!-- Images will be loaded here -->
            </div>
        </div>

        <!-- PDFs Gallery -->
        <div class="card" id="pdfsSection" style="display: none;">
            <div class="gallery-title">
                <i class="fas fa-file-pdf"></i>
                <span>PDF Documents</span>
            </div>
            <div class="scrollable-gallery" id="pdfsGallery">
                <!-- PDFs will be loaded here -->
            </div>
        </div>

        <!-- Empty state (initially shown) -->
        <div class="card" id="emptyState">
            <div class="empty-state">
                <i class="fas fa-folder-open"></i>
                <h3>No Homework Loaded</h3>
                <p>Homework data will appear here once loaded.</p>
                <button class="btn btn-download" id="loadSampleBtn" style="margin-top: 15px;">
                    <i class="fas fa-download"></i> Load Sample Homework
                </button>
            </div>
        </div>
    </div>

    <!-- Full Screen Image Gallery -->
    <div class="fullscreen-gallery" id="fullscreenImageGallery">
        <div class="gallery-header">
            <h2><i class="fas fa-images"></i> All Images</h2>
            <button class="close-gallery" id="closeImageGallery">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="gallery-grid" id="imageGrid">
            <!-- Images will be loaded here in grid -->
        </div>
    </div>

    <!-- Full Screen PDF Gallery -->
    <div class="fullscreen-gallery" id="fullscreenPDFGallery">
        <div class="gallery-header">
            <h2><i class="fas fa-file-pdf"></i> All PDF Documents</h2>
            <button class="close-gallery" id="closePDFGallery">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="gallery-grid" id="pdfGrid">
            <!-- PDFs will be loaded here in grid -->
        </div>
    </div>

    <!-- Download Page -->
    <div class="download-page" id="downloadPage">
        <div class="download-header">
            <h2><i class="fas fa-download"></i> Download All Files</h2>
            <button class="close-gallery" id="closeDownloadPage">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="download-list" id="downloadList">
            <!-- Download items will be loaded here -->
        </div>
        <div class="empty-download-animation" id="emptyDownloadAnimation" style="display: none;">
            <div class="empty-animation-container">
                <div class="empty-circle"></div>
                <div class="empty-icon">
                    <i class="fas fa-box-open"></i>
                </div>
            </div>
            <h3>No Files to Download</h3>
            <p>There are no files available for download at the moment.</p>
            <button class="btn btn-download" id="refreshDownloadBtn" style="margin-top: 15px;">
                <i class="fas fa-sync-alt"></i> Check Again
            </button>
        </div>
    </div>

    <!-- Enhanced Image Viewer Modal with Zoom, Drag and Rotate -->
    <div class="image-modal" id="imageModal">
        <div class="image-modal-content">
            <!-- Swipe back indicator -->
            <div class="swipe-back-indicator" id="swipeBackIndicator">
                <i class="fas fa-chevron-left"></i>
            </div>
            
            <!-- Pinch zoom indicator -->
            <div class="pinch-indicator" id="pinchIndicator">
                Pinch to zoom • Double tap to reset
            </div>
            
            <div class="image-container" id="imageContainer">
                <img class="image-modal-img" id="imageModalImg" src="" alt="Homework Image">
            </div>
            
            <!-- Image controls -->
            <div class="image-controls">
                <button class="image-control-btn" id="rotateLeftBtn" title="Rotate Left">
                    <i class="fas fa-undo"></i>
                </button>
                <button class="image-control-btn" id="rotateRightBtn" title="Rotate Right">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <!-- Zoom controls -->
            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button class="zoom-btn" id="zoomInBtn" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
            
            <!-- Reset button -->
            <button class="reset-btn" id="resetImageBtn" title="Reset Zoom & Rotation">
                <i class="fas fa-sync-alt"></i>
            </button>
            
            <!-- Zoom level indicator -->
            <div class="zoom-level" id="zoomLevel">
                100%
            </div>
            
            <!-- Rotate indicator -->
            <div class="rotate-indicator" id="rotateIndicator">
                0°
            </div>
            
            <!-- Navigation arrows -->
            <button class="nav-arrow nav-arrow-left" id="prevImageBtn">
                <i class="fas fa-chevron-left"></i>
            </button>
            
            <button class="nav-arrow nav-arrow-right" id="nextImageBtn">
                <i class="fas fa-chevron-right"></i>
            </button>
            
            <!-- Close button -->
            <button class="image-modal-close" id="closeImageModal">
                <i class="fas fa-times"></i>
            </button>
            
            <!-- Download button -->
            <button class="image-download-btn" id="downloadCurrentImageBtn">
                <i class="fas fa-download"></i>
            </button>
            
            <!-- Image counter -->
            <div class="image-counter" id="imageCounter">1 / 1</div>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="pdfModalTitle">PDF Viewer</div>
                <button class="modal-close" id="closePdfModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="pdf-viewer" id="pdfViewer">
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading PDF...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Download Progress Modal -->
    <div class="download-progress" id="downloadProgress">
        <i class="fas fa-download" style="font-size: 2rem; color: var(--eco-green);"></i>
        <div style="font-weight: 600; color: var(--eco-text);" id="downloadProgressText">Downloading...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div style="font-size: 0.8rem; color: #5f6368;" id="downloadFileName"></div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Operation completed</span>
    </div>

    <!-- Fixed Bottom Navigation - ALWAYS VISIBLE -->
    <div class="bottom-nav">
        <div class="nav-item active" id="navHome">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </div>
        <div class="nav-item" id="navImages">
            <i class="fas fa-images"></i>
            <span>Images</span>
        </div>
        <div class="nav-item" id="navPDFs">
            <i class="fas fa-file-pdf"></i>
            <span>PDFs</span>
        </div>
        <div class="nav-item" id="navDownload">
            <i class="fas fa-download"></i>
            <span>Download</span>
        </div>
    </div>

    <!-- Countdown Timer at Bottom -->
    <div class="countdown-timer" id="countdownTimer">
        <i class="fas fa-clock"></i>
        <span class="countdown-text">Deletion in:</span>
        <span class="countdown-value" id="countdownValue">Calculating...</span>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDcKkAf2SRmfiJizVA71fILOqRZTtUGAdY",
            authDomain: "schooladmin-51cdd.firebaseapp.com",
            databaseURL: "https://schooladmin-51cdd-default-rtdb.firebaseio.com",
            projectId: "schooladmin-51cdd",
            storageBucket: "schooladmin-51cdd.firebasestorage.app",
            messagingSenderId: "185301938780",
            appId: "1:185301938780:web:bdeaabff3c7d2bff2bac99",
            measurementId: "G-V8C5DE930K"
        };

        // Get homework ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const homeworkId = urlParams.get('id') || '-Oi5063ahSKuVGS_CV1w';
        const title = urlParams.get('title') || 'All syllabus';
        const subject = urlParams.get('subject') || 'Class 12th business';
        const date = urlParams.get('date') || '04-01-2026 04:09:56';

        // Deletion timestamp (1770071996916 = March 2, 2026)
        const deletionTimestamp = 1770071996916;

        // DOM Elements
        const pageTitle = document.getElementById('pageTitle');
        const subjectTitle = document.getElementById('subjectTitle');
        const subjectValue = document.getElementById('subjectValue');
        const dateValue = document.getElementById('dateValue');
        const imagesCount = document.getElementById('imagesCount');
        const pdfsCount = document.getElementById('pdfsCount');
        const uploadTimeValue = document.getElementById('uploadTimeValue');
        const deletionCountdown = document.getElementById('deletionCountdown');
        const deletionCountdownValue = document.getElementById('deletionCountdownValue');
        
        const imagesSection = document.getElementById('imagesSection');
        const pdfsSection = document.getElementById('pdfsSection');
        const imagesGallery = document.getElementById('imagesGallery');
        const pdfsGallery = document.getElementById('pdfsGallery');
        const emptyState = document.getElementById('emptyState');
        
        // Full screen galleries
        const fullscreenImageGallery = document.getElementById('fullscreenImageGallery');
        const fullscreenPDFGallery = document.getElementById('fullscreenPDFGallery');
        const imageGrid = document.getElementById('imageGrid');
        const pdfGrid = document.getElementById('pdfGrid');
        
        // Download page
        const downloadPage = document.getElementById('downloadPage');
        const downloadList = document.getElementById('downloadList');
        const emptyDownloadAnimation = document.getElementById('emptyDownloadAnimation');
        
        // Enhanced Image Modal elements
        const imageModal = document.getElementById('imageModal');
        const imageModalImg = document.getElementById('imageModalImg');
        const imageContainer = document.getElementById('imageContainer');
        const closeImageModal = document.getElementById('closeImageModal');
        const prevImageBtn = document.getElementById('prevImageBtn');
        const nextImageBtn = document.getElementById('nextImageBtn');
        const downloadCurrentImageBtn = document.getElementById('downloadCurrentImageBtn');
        const imageCounter = document.getElementById('imageCounter');
        
        // Image control elements
        const rotateLeftBtn = document.getElementById('rotateLeftBtn');
        const rotateRightBtn = document.getElementById('rotateRightBtn');
        const zoomInBtn = document.getElementById('zoomInBtn');
        const zoomOutBtn = document.getElementById('zoomOutBtn');
        const resetImageBtn = document.getElementById('resetImageBtn');
        const zoomLevel = document.getElementById('zoomLevel');
        const rotateIndicator = document.getElementById('rotateIndicator');
        const swipeBackIndicator = document.getElementById('swipeBackIndicator');
        const pinchIndicator = document.getElementById('pinchIndicator');
        
        // PDF Modal
        const pdfModal = document.getElementById('pdfModal');
        const pdfViewer = document.getElementById('pdfViewer');
        const pdfModalTitle = document.getElementById('pdfModalTitle');
        const closePdfModal = document.getElementById('closePdfModal');
        
        // Download Progress
        const downloadProgress = document.getElementById('downloadProgress');
        const downloadProgressText = document.getElementById('downloadProgressText');
        const progressFill = document.getElementById('progressFill');
        const downloadFileName = document.getElementById('downloadFileName');
        
        // Buttons
        const refreshBtn = document.getElementById('refreshBtn');
        const loadSampleBtn = document.getElementById('loadSampleBtn');
        const refreshDownloadBtn = document.getElementById('refreshDownloadBtn');
        
        // Close buttons for galleries
        const closeImageGallery = document.getElementById('closeImageGallery');
        const closePDFGallery = document.getElementById('closePDFGallery');
        const closeDownloadPage = document.getElementById('closeDownloadPage');
        
        // Toast
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        
        // Navigation elements
        const navHome = document.getElementById('navHome');
        const navImages = document.getElementById('navImages');
        const navPDFs = document.getElementById('navPDFs');
        const navDownload = document.getElementById('navDownload');
        
        // Countdown timer
        const countdownTimer = document.getElementById('countdownTimer');
        const countdownValue = document.getElementById('countdownValue');

        // Global variables
        let homeworkData = null;
        let currentPdfUrl = null;
        let allImages = [];
        let allPDFs = [];
        let deletionCountdownInterval = null;
        let uploadCountdownInterval = null;
        
        // Image viewer navigation variables
        let currentImageIndex = 0;
        let touchStartX = 0;
        let touchEndX = 0;
        let touchStartY = 0;
        let touchEndY = 0;
        let isSwiping = false;
        let swipeStartX = 0;
        
        // Image zoom and transform variables
        let currentScale = 1;
        let minScale = 0.5;
        let maxScale = 5;
        let currentRotation = 0;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let translateX = 0;
        let translateY = 0;
        let lastTouchDistance = 0;
        let isPinching = false;
        
        // Track downloaded files
        let downloadedFiles = JSON.parse(localStorage.getItem('downloadedFiles') || '{}');

        // Initialize all countdown timers
        function initCountdownTimers() {
            // Bottom countdown timer (from deletion timestamp)
            const deletionTime = deletionTimestamp;
            const now = Date.now();
            
            if (deletionTime <= now) {
                countdownValue.textContent = "Already Deleted";
                countdownTimer.style.background = "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)";
                return;
            }
            
            // Update countdown every second
            deletionCountdownInterval = setInterval(updateDeletionCountdown, 1000);
            updateDeletionCountdown(); // Initial call
            
            // Upload countdown (30 days from upload date)
            if (homeworkData && homeworkData.createdDate) {
                startUploadCountdown();
            }
        }
        
        function updateDeletionCountdown() {
            const deletionTime = deletionTimestamp;
            const now = Date.now();
            const timeLeft = deletionTime - now;
            
            if (timeLeft <= 0) {
                clearInterval(deletionCountdownInterval);
                countdownValue.textContent = "00:00:00:00";
                countdownTimer.style.background = "linear-gradient(135deg, #f44336 0%, #d32f2f 100%)";
                showToast("Homework has been deleted", "error");
                return;
            }
            
            // Calculate days, hours, minutes, seconds
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Format as DD:HH:MM:SS
            countdownValue.textContent = 
                `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Change color based on urgency
            if (days < 1) {
                countdownTimer.style.background = "linear-gradient(135deg, #ff9800 0%, #f57c00 100%)";
            } else if (days < 3) {
                countdownTimer.style.background = "linear-gradient(135deg, #ffb74d 0%, #ff9800 100%)";
            }
        }
        
        function startUploadCountdown() {
            // Parse the upload date (format: DD-MM-YYYY HH:MM:SS)
            const dateStr = homeworkData.createdDate;
            const dateParts = dateStr.split(' ')[0].split('-');
            const timeParts = dateStr.split(' ')[1] ? dateStr.split(' ')[1].split(':') : ['00', '00', '00'];
            
            // Create date object (note: months are 0-indexed in JavaScript)
            const uploadDate = new Date(
                parseInt(dateParts[2]), // year
                parseInt(dateParts[1]) - 1, // month (0-indexed)
                parseInt(dateParts[0]), // day
                parseInt(timeParts[0]), // hours
                parseInt(timeParts[1]), // minutes
                parseInt(timeParts[2])  // seconds
            );
            
            // Add 30 days to upload date
            const expirationDate = new Date(uploadDate);
            expirationDate.setDate(expirationDate.getDate() + 30);
            
            // Show deletion countdown
            deletionCountdown.style.display = 'block';
            
            // Update every second
            uploadCountdownInterval = setInterval(() => updateUploadCountdown(expirationDate), 1000);
            updateUploadCountdown(expirationDate); // Initial call
        }
        
        function updateUploadCountdown(expirationDate) {
            const now = new Date();
            const timeLeft = expirationDate - now;
            
            if (timeLeft <= 0) {
                clearInterval(uploadCountdownInterval);
                deletionCountdownValue.textContent = "EXPIRED";
                deletionCountdown.style.background = "#ffebee";
                deletionCountdown.style.borderLeftColor = "#f44336";
                return;
            }
            
            // Calculate days, hours, minutes, seconds
            const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
            const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            // Format as DD:HH:MM:SS
            deletionCountdownValue.textContent = 
                `${days.toString().padStart(2, '0')}:${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            // Update upload time display
            uploadTimeValue.textContent = deletionCountdownValue.textContent;
            
            // Change color based on remaining time
            if (days < 7) {
                deletionCountdown.style.background = "#fff3e0";
                deletionCountdown.style.borderLeftColor = "#ff9800";
                deletionCountdownValue.style.color = "#e65100";
            }
            if (days < 3) {
                deletionCountdown.style.background = "#ffebee";
                deletionCountdown.style.borderLeftColor = "#f44336";
                deletionCountdownValue.style.color = "#c62828";
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            toast.style.background = type === 'error' ? '#e53935' : type === 'info' ? 'var(--eco-green)' : 'var(--eco-accent)';
            toast.style.display = 'flex';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        // Show download progress
        function showDownloadProgress(fileName) {
            downloadProgressText.textContent = 'Downloading...';
            downloadFileName.textContent = fileName;
            progressFill.style.width = '0%';
            downloadProgress.style.display = 'flex';
            
            // Simulate progress animation
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                progressFill.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        downloadProgress.style.display = 'none';
                    }, 500);
                }
            }, 50);
        }

        // Fix Firebase Storage URL
        function fixFirebaseUrl(url) {
            try {
                // If it's already a proper URL, return it
                if (url.startsWith('http')) {
                    return url;
                }
                
                // If it looks like a Firebase Storage path
                if (url.includes('%2F') || url.includes('/')) {
                    // Encode the path properly
                    const encodedPath = encodeURIComponent(url);
                    // Return as Firebase Storage download URL
                    return `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/${encodedPath}?alt=media`;
                }
                
                // Default: assume it's a filename in root
                const encodedPath = encodeURIComponent(url);
                return `https://firebasestorage.googleapis.com/v0/b/${firebaseConfig.storageBucket}/o/${encodedPath}?alt=media`;
            } catch (error) {
                console.error('Error fixing URL:', error);
                return url;
            }
        }

        // Extract file name from URL
        function getFileNameFromUrl(url) {
            try {
                // Remove query parameters
                const cleanUrl = url.split('?')[0];
                const segments = cleanUrl.split('/');
                let fileName = segments.pop() || 'file';
                
                // Decode URL encoding
                fileName = decodeURIComponent(fileName);
                
                // Extract just the filename if it has Firebase parameters
                if (fileName.includes('%2F')) {
                    fileName = fileName.split('%2F').pop();
                }
                
                // Clean special characters but keep extension
                const extension = fileName.split('.').pop();
                const nameWithoutExt = fileName.substring(0, fileName.length - extension.length - 1);
                const cleanName = nameWithoutExt.replace(/[^a-zA-Z0-9\s_-]/g, ' ').trim();
                
                return (cleanName || 'file') + '.' + extension;
            } catch {
                return 'file';
            }
        }

        // Download file with proper download attribute
        function downloadFile(url, fileName = null) {
            try {
                const actualFileName = fileName || getFileNameFromUrl(url);
                showDownloadProgress(actualFileName);
                
                // Create a temporary link element
                const link = document.createElement('a');
                link.href = url;
                link.download = actualFileName;
                link.target = '_blank';
                
                // Add link to document, click it, and remove it
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Track downloaded file
                downloadedFiles[url] = {
                    name: actualFileName,
                    date: new Date().toISOString(),
                    type: url.toLowerCase().includes('.pdf') ? 'pdf' : 'image'
                };
                localStorage.setItem('downloadedFiles', JSON.stringify(downloadedFiles));
                
                setTimeout(() => {
                    showToast(`${actualFileName} downloaded successfully!`);
                }, 1000);
                
            } catch (error) {
                console.error('Download error:', error);
                
                // Fallback method for mobile devices
                if (error.name === 'NetworkError' || error.message.includes('network')) {
                    showToast('Opening file in new tab for download...', 'info');
                    window.open(url, '_blank');
                } else {
                    showToast('Error downloading file. Try opening in new tab.', 'error');
                    
                    // Alternative method for iOS Safari
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                    if (isIOS) {
                        showToast('For iOS: Press and hold the image, then select "Save Image"', 'info');
                    }
                }
            }
        }

        // Enhanced download function for images that forces download
        function downloadImage(imageUrl, imageName) {
            // Show progress immediately
            showDownloadProgress(imageName);
            
            // For images, we need to fetch and create a blob URL
            fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    // Create object URL from blob
                    const blobUrl = URL.createObjectURL(blob);
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = imageName;
                    
                    // Append to body, click and remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up the blob URL
                    setTimeout(() => URL.revokeObjectURL(blobUrl), 100);
                    
                    // Track downloaded file
                    downloadedFiles[imageUrl] = {
                        name: imageName,
                        date: new Date().toISOString(),
                        type: 'image'
                    };
                    localStorage.setItem('downloadedFiles', JSON.stringify(downloadedFiles));
                    
                    // Show success message
                    setTimeout(() => {
                        showToast(`"${imageName}" saved to gallery!`);
                    }, 1000);
                })
                .catch(error => {
                    console.error('Image download error:', error);
                    showToast('Error downloading image. Trying alternative method...', 'error');
                    
                    // Fallback to regular download method
                    downloadFile(imageUrl, imageName);
                });
        }

        // Open image in enhanced viewer with navigation
        function openImage(url, fileName, index = 0) {
            currentImageIndex = index;
            resetImageTransform(); // Reset zoom and rotation
            updateImageModal();
            imageModal.style.display = 'flex';
            
            // Add touch event listeners for swipe navigation and zoom
            setupImageInteraction();
        }

        // Reset image transform to default
        function resetImageTransform() {
            currentScale = 1;
            currentRotation = 0;
            translateX = 0;
            translateY = 0;
            updateImageTransform();
        }

        // Update image transform with current scale, rotation and position
        function updateImageTransform() {
            const transform = `translate(${translateX}px, ${translateY}px) scale(${currentScale}) rotate(${currentRotation}deg)`;
            imageModalImg.style.transform = transform;
            
            // Update indicators
            zoomLevel.textContent = `${Math.round(currentScale * 100)}%`;
            rotateIndicator.textContent = `${currentRotation}°`;
            
            // Show pinch indicator briefly
            showPinchIndicator();
        }

        // Show pinch indicator
        function showPinchIndicator() {
            pinchIndicator.classList.add('show');
            setTimeout(() => {
                pinchIndicator.classList.remove('show');
            }, 2000);
        }

        // Setup image interaction (zoom, drag, rotate, swipe)
        function setupImageInteraction() {
            const img = imageModalImg;
            const container = imageContainer;
            
            // Remove existing listeners
            container.removeEventListener('touchstart', handleTouchStart);
            container.removeEventListener('touchmove', handleTouchMove);
            container.removeEventListener('touchend', handleTouchEnd);
            container.removeEventListener('mousedown', handleMouseDown);
            container.removeEventListener('mousemove', handleMouseMove);
            container.removeEventListener('mouseup', handleMouseUp);
            container.removeEventListener('mouseleave', handleMouseUp);
            container.removeEventListener('wheel', handleWheel);
            img.removeEventListener('dblclick', handleDoubleClick);
            
            // Add new listeners
            container.addEventListener('touchstart', handleTouchStart, { passive: false });
            container.addEventListener('touchmove', handleTouchMove, { passive: false });
            container.addEventListener('touchend', handleTouchEnd, { passive: true });
            container.addEventListener('mousedown', handleMouseDown);
            container.addEventListener('mousemove', handleMouseMove);
            container.addEventListener('mouseup', handleMouseUp);
            container.addEventListener('mouseleave', handleMouseUp);
            container.addEventListener('wheel', handleWheel, { passive: false });
            img.addEventListener('dblclick', handleDoubleClick);
        }

        // Touch event handlers
        function handleTouchStart(e) {
            e.preventDefault();
            
            if (e.touches.length === 1) {
                // Single touch for drag and swipe
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                isSwiping = true;
                swipeStartX = touchStartX;
                
                // Show swipe back indicator if near left edge
                if (touchStartX < 50) {
                    swipeBackIndicator.classList.add('show');
                }
            } else if (e.touches.length === 2) {
                // Two touches for pinch zoom
                isPinching = true;
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
            }
        }

        function handleTouchMove(e) {
            e.preventDefault();
            
            if (isPinching && e.touches.length === 2) {
                // Handle pinch zoom
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) +
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                
                if (lastTouchDistance > 0) {
                    const scaleChange = currentDistance / lastTouchDistance;
                    currentScale *= scaleChange;
                    currentScale = Math.max(minScale, Math.min(maxScale, currentScale));
                    updateImageTransform();
                }
                
                lastTouchDistance = currentDistance;
            } else if (isSwiping && e.touches.length === 1) {
                // Handle drag and swipe
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                
                if (currentScale > 1) {
                    // Dragging zoomed image
                    const deltaX = touchX - touchStartX;
                    const deltaY = touchY - touchStartY;
                    
                    translateX += deltaX;
                    translateY += deltaY;
                    
                    touchStartX = touchX;
                    touchStartY = touchY;
                    
                    updateImageTransform();
                } else {
                    // Swiping for navigation
                    touchEndX = touchX;
                    touchEndY = touchY;
                    
                    // Show swipe back indicator if swiping from left edge
                    if (swipeStartX < 50 && touchX > swipeStartX + 30) {
                        swipeBackIndicator.classList.add('show');
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            
            if (isSwiping && !isPinching) {
                // Check for swipe gesture
                const swipeThreshold = 50;
                const swipeDistance = touchEndX - touchStartX;
                
                if (Math.abs(swipeDistance) > swipeThreshold) {
                    if (swipeDistance > 0 && swipeStartX < 50) {
                        // Swipe from left edge to go back
                        if (fullscreenImageGallery.style.display === 'flex') {
                            closeFullscreenImageGallery();
                        } else if (fullscreenPDFGallery.style.display === 'flex') {
                            closeFullscreenPDFGallery();
                        } else if (downloadPage.style.display === 'flex') {
                            closeDownloadPageFunc();
                        } else if (imageModal.style.display === 'flex') {
                            closeImageModalFunc();
                        } else {
                            // Go to home
                            navHome.click();
                        }
                    } else if (swipeDistance < 0 && currentScale === 1) {
                        // Swipe left for next image (only when not zoomed)
                        showNextImage();
                    } else if (swipeDistance > 0 && currentScale === 1) {
                        // Swipe right for previous image (only when not zoomed)
                        showPreviousImage();
                    }
                }
            }
            
            // Reset states
            isSwiping = false;
            isPinching = false;
            lastTouchDistance = 0;
            touchStartX = 0;
            touchEndX = 0;
            swipeStartX = 0;
            swipeBackIndicator.classList.remove('show');
        }

        // Mouse event handlers
        function handleMouseDown(e) {
            e.preventDefault();
            if (currentScale > 1) {
                isDragging = true;
                dragStartX = e.clientX - translateX;
                dragStartY = e.clientY - translateY;
                imageContainer.classList.add('grabbing');
            }
        }

        function handleMouseMove(e) {
            if (isDragging) {
                e.preventDefault();
                translateX = e.clientX - dragStartX;
                translateY = e.clientY - dragStartY;
                updateImageTransform();
            }
        }

        function handleMouseUp() {
            isDragging = false;
            imageContainer.classList.remove('grabbing');
        }

        // Wheel for zoom
        function handleWheel(e) {
            e.preventDefault();
            if (e.ctrlKey) {
                // Pinch zoom simulation with Ctrl+wheel
                const zoomFactor = 0.1;
                if (e.deltaY < 0) {
                    // Zoom in
                    currentScale = Math.min(maxScale, currentScale + zoomFactor);
                } else {
                    // Zoom out
                    currentScale = Math.max(minScale, currentScale - zoomFactor);
                }
                updateImageTransform();
            }
        }

        // Double click to reset
        function handleDoubleClick() {
            resetImageTransform();
            showToast("Image reset to default", "info");
        }

        // Zoom functions
        function zoomIn() {
            currentScale = Math.min(maxScale, currentScale + 0.25);
            updateImageTransform();
        }

        function zoomOut() {
            currentScale = Math.max(minScale, currentScale - 0.25);
            updateImageTransform();
        }

        // Rotate functions
        function rotateLeft() {
            currentRotation -= 90;
            updateImageTransform();
        }

        function rotateRight() {
            currentRotation += 90;
            updateImageTransform();
        }

        // Update image modal with current image
        function updateImageModal() {
            if (allImages.length === 0) return;
            
            const currentImage = allImages[currentImageIndex];
            imageModalImg.src = currentImage.url;
            imageModalImg.alt = currentImage.name;
            
            // Reset transform when changing images
            resetImageTransform();
            
            // Update counter
            imageCounter.textContent = `${currentImageIndex + 1} / ${allImages.length}`;
            
            // Show/hide navigation arrows
            if (allImages.length > 1) {
                prevImageBtn.classList.add('show');
                nextImageBtn.classList.add('show');
            } else {
                prevImageBtn.classList.remove('show');
                nextImageBtn.classList.remove('show');
            }
            
            // Update download button with current image data
            downloadCurrentImageBtn.onclick = () => {
                downloadImage(currentImage.url, currentImage.name);
            };
        }

        // Navigate to previous image
        function showPreviousImage() {
            if (allImages.length <= 1) return;
            
            currentImageIndex = (currentImageIndex - 1 + allImages.length) % allImages.length;
            updateImageModal();
        }

        // Navigate to next image
        function showNextImage() {
            if (allImages.length <= 1) return;
            
            currentImageIndex = (currentImageIndex + 1) % allImages.length;
            updateImageModal();
        }

        // Open PDF in modal
        function openPdf(url, fileName) {
            currentPdfUrl = url;
            pdfModalTitle.textContent = fileName;
            
            // Show loading
            pdfViewer.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <div>Loading PDF...</div>
                </div>
            `;
            
            // Show modal
            pdfModal.style.display = 'flex';
            
            // Create iframe for PDF
            setTimeout(() => {
                loadPdfInIframe(url);
            }, 500);
        }

        // Load PDF in iframe with fallback
        function loadPdfInIframe(url) {
            // Try Google Docs viewer for mobile compatibility
            const googleViewerUrl = `https://docs.google.com/gview?embedded=true&url=${encodeURIComponent(url)}`;
            const iframe = document.createElement('iframe');
            iframe.className = 'pdf-iframe';
            iframe.src = googleViewerUrl;
            iframe.title = 'PDF Viewer';
            
            pdfViewer.innerHTML = '';
            pdfViewer.appendChild(iframe);
            
            // Fallback if iframe fails
            iframe.onerror = () => {
                pdfViewer.innerHTML = `
                    <div style="padding: 40px; text-align: center;">
                        <div style="font-size: 48px; color: var(--eco-green); margin-bottom: 20px;">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h3 style="margin-bottom: 15px; color: var(--eco-text);">PDF Viewer Not Available</h3>
                        <p style="color: #5f6368; margin-bottom: 25px; line-height: 1.6;">
                            The PDF cannot be displayed directly in the browser.<br>
                            Please download it to view on your device.
                        </p>
                        <div style="display: flex; gap: 15px; justify-content: center;">
                            <button class="btn btn-download" onclick="downloadFile('${url}', '${getFileNameFromUrl(url)}')">
                                <i class="fas fa-download"></i> Download PDF
                            </button>
                            <button class="btn btn-view" onclick="window.open('${url}', '_blank')">
                                <i class="fas fa-external-link-alt"></i> Open in New Tab
                            </button>
                        </div>
                    </div>
                `;
            };
        }

        // Load homework data
        async function loadHomeworkData() {
            try {
                showToast('Loading homework...', 'info');
                
                // Load from Firebase
                const response = await fetch(`${firebaseConfig.databaseURL}/homeworks/${homeworkId}.json`);
                const data = await response.json();
                
                if (data) {
                    homeworkData = data;
                    updateUI();
                    showToast('Homework loaded successfully');
                } else {
                    // If no Firebase data, use URL parameters
                    useUrlParameters();
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                // Fallback to URL parameters
                useUrlParameters();
            }
        }

        // Use URL parameters when Firebase data is not available
        function useUrlParameters() {
            homeworkData = {
                chapterName: title,
                subject: subject,
                createdDate: date,
                imageUrls: [],
                pdfUrls: []
            };
            
            updateUI();
            showToast('Loaded from URL parameters', 'info');
        }

        // Update UI
        function updateUI() {
            if (!homeworkData) return;

            // Hide empty state
            emptyState.style.display = 'none';
            
            // Set page title
            document.title = `${homeworkData.chapterName || title} - Eco Homework Viewer`;
            pageTitle.textContent = homeworkData.chapterName || title;
            subjectTitle.textContent = homeworkData.chapterName || title;
            subjectValue.textContent = homeworkData.subject || subject;
            dateValue.textContent = homeworkData.createdDate || date;

            // Load files
            loadFiles();
            
            // Initialize countdown timers
            initCountdownTimers();
        }

        // Load files from Firebase
        async function loadFiles() {
            try {
                // Reset arrays
                allImages = [];
                allPDFs = [];
                
                // Check for imageUrls
                if (homeworkData.imageUrls && Array.isArray(homeworkData.imageUrls)) {
                    homeworkData.imageUrls.forEach(url => {
                        if (url && typeof url === 'string') {
                            allImages.push({
                                url: fixFirebaseUrl(url),
                                name: getFileNameFromUrl(url),
                                type: 'image'
                            });
                        }
                    });
                }
                
                // Check for pdfUrls
                if (homeworkData.pdfUrls && Array.isArray(homeworkData.pdfUrls)) {
                    homeworkData.pdfUrls.forEach(url => {
                        if (url && typeof url === 'string') {
                            allPDFs.push({
                                url: fixFirebaseUrl(url),
                                name: getFileNameFromUrl(url),
                                type: 'pdf'
                            });
                        }
                    });
                }
                
                // Check for fileUrls (legacy format)
                if (homeworkData.fileUrls && Array.isArray(homeworkData.fileUrls)) {
                    homeworkData.fileUrls.forEach(url => {
                        if (!url || typeof url !== 'string') return;
                        
                        const fixedUrl = fixFirebaseUrl(url);
                        const fileName = getFileNameFromUrl(url);
                        
                        if (url.toLowerCase().match(/\.(jpg|jpeg|png|gif|webp|bmp)$/)) {
                            allImages.push({
                                url: fixedUrl,
                                name: fileName,
                                type: 'image'
                            });
                        } else if (url.toLowerCase().includes('.pdf')) {
                            allPDFs.push({
                                url: fixedUrl,
                                name: fileName,
                                type: 'pdf'
                            });
                        }
                    });
                }
                
                // Update counts
                imagesCount.textContent = allImages.length;
                pdfsCount.textContent = allPDFs.length;
                
                // Render galleries
                renderImageGallery();
                renderPdfGallery();
                
                // Show sections if there are files
                if (allImages.length > 0) {
                    imagesSection.style.display = 'block';
                }
                
                if (allPDFs.length > 0) {
                    pdfsSection.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Error loading files:', error);
                showToast('Error loading files', 'error');
            }
        }

        // Render image gallery
        function renderImageGallery() {
            if (allImages.length === 0) {
                imagesGallery.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #5f6368; width: 100%;">
                        <i class="fas fa-image" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No images available</p>
                    </div>
                `;
                return;
            }
            
            imagesGallery.innerHTML = '';
            
            // Only show first 3 images in the preview gallery
            const previewImages = allImages.slice(0, 3);
            
            previewImages.forEach((image, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                item.innerHTML = `
                    <div class="gallery-preview image-preview">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="gallery-info">
                        <div class="gallery-name" title="${image.name}">
                            ${image.name}
                        </div>
                        <div class="gallery-actions">
                            <button class="btn btn-view view-image" data-index="${index}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-download download-image" data-url="${image.url}" data-name="${image.name}">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                `;
                
                imagesGallery.appendChild(item);
            });
            
            // Add "View All" button if there are more than 3 images
            if (allImages.length > 3) {
                const viewAllItem = document.createElement('div');
                viewAllItem.className = 'gallery-item';
                viewAllItem.innerHTML = `
                    <div class="gallery-preview image-preview" style="background: linear-gradient(135deg, var(--eco-green) 0%, var(--eco-light-green) 100%);">
                        <i class="fas fa-th-large" style="color: white; font-size: 48px;"></i>
                    </div>
                    <div class="gallery-info">
                        <div class="gallery-name">
                            View All ${allImages.length} Images
                        </div>
                        <div class="gallery-actions">
                            <button class="btn btn-view" id="viewAllImagesBtn">
                                <i class="fas fa-expand"></i> View All
                            </button>
                        </div>
                    </div>
                `;
                imagesGallery.appendChild(viewAllItem);
            }
            
            // Add event listeners
            document.querySelectorAll('.view-image').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    const image = allImages[index];
                    openImage(image.url, image.name, index);
                });
            });
            
            document.querySelectorAll('.download-image').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    downloadImage(url, name);
                });
            });
            
            // Add event listener for "View All" button
            const viewAllBtn = document.getElementById('viewAllImagesBtn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', () => {
                    openFullscreenImageGallery();
                });
            }
        }

        // Render PDF gallery
        function renderPdfGallery() {
            if (allPDFs.length === 0) {
                pdfsGallery.innerHTML = `
                    <div style="padding: 20px; text-align: center; color: #5f6368; width: 100%;">
                        <i class="fas fa-file-pdf" style="font-size: 24px; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>No PDFs available</p>
                    </div>
                `;
                return;
            }
            
            pdfsGallery.innerHTML = '';
            
            // Only show first 3 PDFs in the preview gallery
            const previewPDFs = allPDFs.slice(0, 3);
            
            previewPDFs.forEach((pdf, index) => {
                const item = document.createElement('div');
                item.className = 'gallery-item';
                
                item.innerHTML = `
                    <div class="gallery-preview pdf-preview">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="gallery-info">
                        <div class="gallery-name" title="${pdf.name}">
                            ${pdf.name}
                        </div>
                        <div class="gallery-actions">
                            <button class="btn btn-view view-pdf" data-url="${pdf.url}" data-name="${pdf.name}">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-download download-pdf" data-url="${pdf.url}" data-name="${pdf.name}">
                                <i class="fas fa-download"></i> Download
                            </button>
                        </div>
                    </div>
                `;
                
                pdfsGallery.appendChild(item);
            });
            
            // Add "View All" button if there are more than 3 PDFs
            if (allPDFs.length > 3) {
                const viewAllItem = document.createElement('div');
                viewAllItem.className = 'gallery-item';
                viewAllItem.innerHTML = `
                    <div class="gallery-preview pdf-preview" style="background: linear-gradient(135deg, #ea4335 0%, #c62828 100%);">
                        <i class="fas fa-th-large" style="color: white; font-size: 48px;"></i>
                    </div>
                    <div class="gallery-info">
                        <div class="gallery-name">
                            View All ${allPDFs.length} PDFs
                        </div>
                        <div class="gallery-actions">
                            <button class="btn btn-view" id="viewAllPDFsBtn">
                                <i class="fas fa-expand"></i> View All
                            </button>
                        </div>
                    </div>
                `;
                pdfsGallery.appendChild(viewAllItem);
            }
            
            // Add event listeners
            document.querySelectorAll('.view-pdf').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    openPdf(url, name);
                });
            });
            
            document.querySelectorAll('.download-pdf').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    downloadFile(url, name);
                });
            });
            
            // Add event listener for "View All" button
            const viewAllBtn = document.getElementById('viewAllPDFsBtn');
            if (viewAllBtn) {
                viewAllBtn.addEventListener('click', () => {
                    openFullscreenPDFGallery();
                });
            }
        }

        // Open fullscreen image gallery
        function openFullscreenImageGallery() {
            if (allImages.length === 0) {
                showToast('No images available', 'info');
                return;
            }
            
            // Render grid with all images (2 per row)
            imageGrid.innerHTML = '';
            
            allImages.forEach((image, index) => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                
                gridItem.innerHTML = `
                    <div class="grid-preview image-preview">
                        <i class="fas fa-image"></i>
                    </div>
                    <div class="grid-info">
                        <div class="grid-name" title="${image.name}">
                            ${image.name}
                        </div>
                        <div class="grid-actions">
                            <button class="btn btn-view view-grid-image" data-index="${index}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-download download-grid-image" data-url="${image.url}" data-name="${image.name}">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                imageGrid.appendChild(gridItem);
            });
            
            // Add event listeners for grid items
            document.querySelectorAll('.view-grid-image').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.closest('button').dataset.index);
                    const image = allImages[index];
                    openImage(image.url, image.name, index);
                });
            });
            
            document.querySelectorAll('.download-grid-image').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    downloadImage(url, name);
                });
            });
            
            // Show the fullscreen gallery
            fullscreenImageGallery.style.display = 'flex';
            setActiveNav(navImages);
        }

        // Close fullscreen image gallery
        function closeFullscreenImageGallery() {
            fullscreenImageGallery.style.display = 'none';
            setActiveNav(navHome);
        }

        // Open fullscreen PDF gallery
        function openFullscreenPDFGallery() {
            if (allPDFs.length === 0) {
                showToast('No PDFs available', 'info');
                return;
            }
            
            // Render grid with all PDFs (2 per row)
            pdfGrid.innerHTML = '';
            
            allPDFs.forEach((pdf, index) => {
                const gridItem = document.createElement('div');
                gridItem.className = 'grid-item';
                
                gridItem.innerHTML = `
                    <div class="grid-preview pdf-preview">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <div class="grid-info">
                        <div class="grid-name" title="${pdf.name}">
                            ${pdf.name}
                        </div>
                        <div class="grid-actions">
                            <button class="btn btn-view view-grid-pdf" data-url="${pdf.url}" data-name="${pdf.name}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-download download-grid-pdf" data-url="${pdf.url}" data-name="${pdf.name}">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                pdfGrid.appendChild(gridItem);
            });
            
            // Add event listeners for grid items
            document.querySelectorAll('.view-grid-pdf').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    openPdf(url, name);
                });
            });
            
            document.querySelectorAll('.download-grid-pdf').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const url = e.target.closest('button').dataset.url;
                    const name = e.target.closest('button').dataset.name;
                    downloadFile(url, name);
                });
            });
            
            // Show the fullscreen gallery
            fullscreenPDFGallery.style.display = 'flex';
            setActiveNav(navPDFs);
        }

        // Close fullscreen PDF gallery
        function closeFullscreenPDFGallery() {
            fullscreenPDFGallery.style.display = 'none';
            setActiveNav(navHome);
        }

        // Open download page
        function openDownloadPage() {
            const allFiles = [...allImages, ...allPDFs];
            
            if (allFiles.length === 0) {
                // Show empty animation
                downloadList.style.display = 'none';
                emptyDownloadAnimation.style.display = 'flex';
            } else {
                // Show download list
                emptyDownloadAnimation.style.display = 'none';
                downloadList.style.display = 'flex';
                
                // Render download list
                downloadList.innerHTML = '';
                
                allFiles.forEach((file, index) => {
                    const downloadItem = document.createElement('div');
                    downloadItem.className = 'download-item';
                    
                    const isImage = file.type === 'image';
                    
                    downloadItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon ${isImage ? 'image' : 'pdf'}">
                                <i class="fas fa-${isImage ? 'image' : 'file-pdf'}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${isImage ? 'Image' : 'PDF'} File</div>
                            </div>
                        </div>
                        <button class="btn btn-download download-single-file" data-url="${file.url}" data-name="${file.name}" data-type="${file.type}">
                            <i class="fas fa-download"></i>
                        </button>
                    `;
                    
                    downloadList.appendChild(downloadItem);
                });
                
                // Add "Download All" button at the top
                const downloadAllItem = document.createElement('div');
                downloadAllItem.className = 'download-item';
                downloadAllItem.style.background = 'linear-gradient(135deg, var(--eco-green) 0%, var(--eco-light-green) 100%)';
                downloadAllItem.style.color = 'white';
                downloadAllItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon" style="background: rgba(255,255,255,0.2); color: white;">
                            <i class="fas fa-download"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name" style="color: white;">Download All Files</div>
                            <div class="file-size" style="color: rgba(255,255,255,0.8);">${allFiles.length} files</div>
                        </div>
                    </div>
                    <button class="btn" id="downloadAllBtn" style="background: white; color: var(--eco-green);">
                        <i class="fas fa-download"></i> Download All
                    </button>
                `;
                
                downloadList.insertBefore(downloadAllItem, downloadList.firstChild);
                
                // Add event listeners
                document.querySelectorAll('.download-single-file').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const url = e.target.closest('button').dataset.url;
                        const name = e.target.closest('button').dataset.name;
                        const type = e.target.closest('button').dataset.type;
                        
                        if (type === 'image') {
                            downloadImage(url, name);
                        } else {
                            downloadFile(url, name);
                        }
                    });
                });
                
                document.getElementById('downloadAllBtn').addEventListener('click', () => {
                    downloadAllFiles();
                });
            }
            
            // Show the download page
            downloadPage.style.display = 'flex';
            setActiveNav(navDownload);
        }

        // Close download page
        function closeDownloadPageFunc() {
            downloadPage.style.display = 'none';
            setActiveNav(navHome);
        }

        // Close image modal
        function closeImageModalFunc() {
            imageModal.style.display = 'none';
        }

        // Download all files
        function downloadAllFiles() {
            const allFiles = [...allImages, ...allPDFs];
            
            if (allFiles.length === 0) {
                showToast('No files to download', 'info');
                return;
            }
            
            showToast(`Starting download of ${allFiles.length} files...`, 'info');
            
            // Download each file one by one
            allFiles.forEach((file, index) => {
                setTimeout(() => {
                    if (file.type === 'image') {
                        downloadImage(file.url, file.name);
                    } else {
                        downloadFile(file.url, file.name);
                    }
                }, index * 1000); // Stagger downloads by 1 second
            });
        }

        // Load sample data for demonstration
        function loadSampleData() {
            // Sample image URLs (placeholder images)
            const sampleImages = [
                {
                    url: 'https://images.unsplash.com/photo-1434030216411-0b793f4b4173?w=400&h=300&fit=crop',
                    name: 'math_homework.jpg',
                    type: 'image'
                },
                {
                    url: 'https://images.unsplash.com/photo-1501504905252-473c47e087f8?w=400&h=300&fit=crop',
                    name: 'science_diagram.png',
                    type: 'image'
                },
                {
                    url: 'https://images.unsplash.com/photo-1456513080510-34499c4359ce?w=400&h=300&fit=crop',
                    name: 'history_notes.jpg',
                    type: 'image'
                },
                {
                    url: 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=400&h=300&fit=crop',
                    name: 'physics_formulas.jpg',
                    type: 'image'
                },
                {
                    url: 'https://images.unsplash.com/photo-1581094794329-c8112a89af12?w=400&h=300&fit=crop',
                    name: 'chemistry_lab.jpg',
                    type: 'image'
                }
            ];
            
            // Sample PDF URLs (placeholder)
            const samplePDFs = [
                {
                    url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
                    name: 'physics_assignments.pdf',
                    type: 'pdf'
                },
                {
                    url: 'https://www.africau.edu/images/default/sample.pdf',
                    name: 'chemistry_notes.pdf',
                    type: 'pdf'
                },
                {
                    url: 'https://www.w3.org/WAI/ER/tests/xhtml/testfiles/resources/pdf/dummy.pdf',
                    name: 'biology_chapter.pdf',
                    type: 'pdf'
                }
            ];
            
            // Update homework data with sample
            homeworkData = {
                chapterName: 'Sample Homework - Environmental Science',
                subject: 'Class 12th Environmental Studies',
                createdDate: '05-01-2026 10:30:00',
                imageUrls: sampleImages.map(img => img.url),
                pdfUrls: samplePDFs.map(pdf => pdf.url)
            };
            
            // Update UI with sample data
            allImages = sampleImages;
            allPDFs = samplePDFs;
            
            imagesCount.textContent = allImages.length;
            pdfsCount.textContent = allPDFs.length;
            
            document.title = `Sample Homework - Eco Homework Viewer`;
            pageTitle.textContent = 'Sample Homework';
            subjectTitle.textContent = 'Sample Homework - Environmental Science';
            subjectValue.textContent = 'Class 12th Environmental Studies';
            dateValue.textContent = '05-01-2026 10:30:00';
            
            emptyState.style.display = 'none';
            
            renderImageGallery();
            renderPdfGallery();
            
            imagesSection.style.display = 'block';
            pdfsSection.style.display = 'block';
            
            // Initialize countdown timers
            initCountdownTimers();
            
            showToast('Sample homework loaded successfully');
        }

        // Navigation functionality
        function setupNavigation() {
            navHome.addEventListener('click', () => {
                // Hide all fullscreen views
                fullscreenImageGallery.style.display = 'none';
                fullscreenPDFGallery.style.display = 'none';
                downloadPage.style.display = 'none';
                imageModal.style.display = 'none';
                pdfModal.style.display = 'none';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
                setActiveNav(navHome);
            });
            
            navImages.addEventListener('click', () => {
                openFullscreenImageGallery();
            });
            
            navPDFs.addEventListener('click', () => {
                openFullscreenPDFGallery();
            });
            
            navDownload.addEventListener('click', () => {
                openDownloadPage();
            });
        }
        
        function setActiveNav(activeItem) {
            // Remove active class from all
            [navHome, navImages, navPDFs, navDownload].forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to clicked item
            activeItem.classList.add('active');
        }

        // Event Listeners
        refreshBtn.addEventListener('click', () => {
            loadHomeworkData();
        });

        loadSampleBtn.addEventListener('click', () => {
            loadSampleData();
        });

        refreshDownloadBtn.addEventListener('click', () => {
            loadHomeworkData();
            showToast('Refreshing files...', 'info');
        });

        // Close buttons
        closePdfModal.addEventListener('click', () => {
            pdfModal.style.display = 'none';
        });

        closeImageModal.addEventListener('click', closeImageModalFunc);
        closeImageGallery.addEventListener('click', closeFullscreenImageGallery);
        closePDFGallery.addEventListener('click', closeFullscreenPDFGallery);
        closeDownloadPage.addEventListener('click', closeDownloadPageFunc);

        // Image control buttons
        rotateLeftBtn.addEventListener('click', rotateLeft);
        rotateRightBtn.addEventListener('click', rotateRight);
        zoomInBtn.addEventListener('click', zoomIn);
        zoomOutBtn.addEventListener('click', zoomOut);
        resetImageBtn.addEventListener('click', () => {
            resetImageTransform();
            showToast("Image reset to default", "info");
        });

        // Image navigation buttons
        prevImageBtn.addEventListener('click', showPreviousImage);
        nextImageBtn.addEventListener('click', showNextImage);

        // Keyboard navigation for image viewer
        document.addEventListener('keydown', (e) => {
            if (imageModal.style.display === 'flex') {
                if (e.key === 'ArrowLeft') {
                    showPreviousImage();
                } else if (e.key === 'ArrowRight') {
                    showNextImage();
                } else if (e.key === 'Escape') {
                    closeImageModalFunc();
                } else if (e.key === '+') {
                    zoomIn();
                } else if (e.key === '-') {
                    zoomOut();
                } else if (e.key === 'r' || e.key === 'R') {
                    resetImageTransform();
                }
            }
            
            // Close other modals with Escape
            if (e.key === 'Escape') {
                pdfModal.style.display = 'none';
                fullscreenImageGallery.style.display = 'none';
                fullscreenPDFGallery.style.display = 'none';
                downloadPage.style.display = 'none';
                setActiveNav(navHome);
            }
        });

        // Close modals on overlay click
        pdfModal.addEventListener('click', (e) => {
            if (e.target === pdfModal) {
                pdfModal.style.display = 'none';
            }
        });

        imageModal.addEventListener('click', (e) => {
            if (e.target === imageModal) {
                closeImageModalFunc();
            }
        });

        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            // Reset image transform on orientation change
            if (imageModal.style.display === 'flex') {
                setTimeout(resetImageTransform, 100);
            }
        });

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadHomeworkData();
            setupNavigation();
            initCountdownTimers();
            
            // Setup swipe to go back for main content
            setupSwipeToGoBack();
        });

        // Setup swipe to go back for main content
        function setupSwipeToGoBack() {
            let startX = 0;
            let startY = 0;
            let isHorizontalSwipe = false;
            
            document.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isHorizontalSwipe = false;
            }, { passive: true });
            
            document.addEventListener('touchmove', (e) => {
                if (!startX || !startY) return;
                
                const diffX = e.touches[0].clientX - startX;
                const diffY = e.touches[0].clientY - startY;
                
                // Determine if it's a horizontal swipe
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    isHorizontalSwipe = true;
                    
                    // Show swipe back indicator if swiping from left edge
                    if (startX < 50 && diffX > 30) {
                        swipeBackIndicator.classList.add('show');
                    }
                }
            }, { passive: true });
            
            document.addEventListener('touchend', (e) => {
                if (!startX || !startY || !isHorizontalSwipe) {
                    startX = 0;
                    startY = 0;
                    swipeBackIndicator.classList.remove('show');
                    return;
                }
                
                const diffX = e.changedTouches[0].clientX - startX;
                
                // If swipe from left edge and moved right significantly
                if (startX < 50 && diffX > 100) {
                    // Go back to previous view
                    if (fullscreenImageGallery.style.display === 'flex') {
                        closeFullscreenImageGallery();
                    } else if (fullscreenPDFGallery.style.display === 'flex') {
                        closeFullscreenPDFGallery();
                    } else if (downloadPage.style.display === 'flex') {
                        closeDownloadPageFunc();
                    } else if (imageModal.style.display === 'flex') {
                        closeImageModalFunc();
                    }
                }
                
                startX = 0;
                startY = 0;
                swipeBackIndicator.classList.remove('show');
            }, { passive: true });
        }

        // Make functions available globally
        window.downloadFile = downloadFile;
        window.downloadImage = downloadImage;
        window.openPdf = openPdf;
        window.openImage = openImage;
        window.downloadAllFiles = downloadAllFiles;
        window.showPreviousImage = showPreviousImage;
        window.showNextImage = showNextImage;
        window.zoomIn = zoomIn;
        window.zoomOut = zoomOut;
        window.rotateLeft = rotateLeft;
        window.rotateRight = rotateRight;
        window.resetImageTransform = resetImageTransform;
    </script>
</body>
</html>
